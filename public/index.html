<!DOCTYPE html>
<html>

<head>
  <title>Ping Pong Game | TAM</title>
</head>

<body style="padding: 0; margin: 0; height: 100vh;">
  <canvas id="canvas" width="800" height="400"></canvas>
  <script type="text/javascript" src="js/app.js"></script>
  <script type="text/javascript">

    app.onInit = function () {
      // Set the game's started state to false 
      this.isStarted = false

      // Calculate the initial bounds
      this.calculateBounds()

      // Add a player and create a reference variable
      this.nodes.push({
        id: 'player-left',
        x: this.leftBound,
        y: this.centerY - this.playerHeight / 2,
        width: this.playerWidth,
        height: this.playerHeight,
        dy: 0,
        color: '#581845'
      });

      this.playerLeft = this.getNode("player-left")

      // Add a player and create a reference variable
      this.nodes.push({
        id: 'player-right',
        x: this.rightBound,
        y: this.centerY - this.playerHeight / 2,
        width: this.playerWidth,
        height: this.playerHeight,
        dy: 0,
        color: '#581845',
      });

      this.playerRight = this.getNode("player-right")

      // Add a ball and create a reference variable
      this.nodes.push({
        id: "ball",
        x: this.centerX - this.ballSide / 2,
        y: this.centerY - this.ballSide / 2,
        width: this.ballSide,
        height: this.ballSide,
        dx: 5,
        dy: 5,
        color: '#FF5733'
      })

      this.ball = this.getNode("ball")
    };

    app.onUpdate = function (time) {
      // Make the game cover the whole browser
      this.canvas.width = this.width
      this.canvas.height = this.height

      // Show a message when game is paused.
      if (!this.isStarted) {
        this.drawText("Click on 'space' to play!", this.centerX, 50)
        return
      }
      // If the playerLeft and playerRight variables are defined, proceed!
      if (this.playerLeft && this.playerRight) {
        this.handlePlayersMovement()
      } else console.log(`Loading...`);

      // if the ball variable is defined, proceed!
      if (this.ball) {
        this.ball.x += this.ball.dx
        this.ball.y += this.ball.dy
        this.handleBallCollision()
        this.checkForWinner()
      }
    };

    // Make sure that players only move within the defined boundaries
    app.handlePlayersMovement = function () {
      const playerRightNewY = this.playerRight.y + this.playerRight.dy
      const playerLeftNewY = this.playerLeft.y + this.playerLeft.dy
      if (playerRightNewY > this.topBound && playerRightNewY < this.bottomBound) {
        this.playerRight.y = playerRightNewY;
      }
      if (playerLeftNewY > this.topBound && playerLeftNewY < this.bottomBound) {
        this.playerLeft.y = playerLeftNewY
      }
    }

    // Check if the ball crossed either of the players, log the winner, and reset the board
    app.checkForWinner = function () {
      // Check if the ball crosses at least 50% of any one of the player's width
      if (this.ball.x < this.playerLeft.x + this.playerLeft.width / 2) {
        console.log(`Player 2 scored`)
        app.reset()
      } else if (this.ball.x + this.ballSide > this.playerRight.x + this.playerRight.width / 2) {
        console.log(`Player 1 scored`)
        app.reset()
      }
    }

    // Reset the game
    app.reset = function () {
      this.resetPlayers()
      this.resetBall()
      this.isStarted = false
    }

    // Reset the players
    app.resetPlayers = function () {
      this.playerRight.x = this.rightBound
      this.playerRight.y = this.centerY - this.playerHeight / 2
      this.playerRight.score = 0

      this.playerLeft.x = this.leftBound
      this.playerLeft.y = this.centerY - this.playerHeight / 2
      this.playerLeft.score = 0
    }

    // Reset the ball
    app.resetBall = function () {
      this.ball.x = this.centerX - this.ballSide / 2
      this.ball.y = this.centerY - this.ballSide / 2
      this.ball.dx = 5
      this.ball.dy = 5

      // Randomize the direction of movement for the ball
      const random = Math.floor((Math.random() * 3) + 1)
      if (random % 3 == 1) {
        this.ball.dx *= -1
      } else if (random % 3 == 0) {
        this.ball.dy *= -1
      }
    }

    // Detect and handle collision
    app.handleBallCollision = function () {
      if ((this.ball.x + this.ballSide >= this.playerRight.x
        && this.ball.x + this.ballSide <= this.playerRight.x + this.playerWidth
        && this.ball.y + this.ballSide >= this.playerRight.y
        && this.ball.y <= this.playerRight.y + this.playerHeight) ||
        (this.ball.x <= this.playerLeft.x + this.playerWidth
          && this.ball.x >= this.playerLeft.x
          && this.ball.y + this.ballSide >= this.playerLeft.y
          && this.ball.y <= this.playerLeft.y + this.playerHeight)) {
        this.ball.dx *= -1
      }

      if (this.ball.y + this.ballSide >= this.height || this.ball.y <= 0) this.ball.dy *= -1
    }

    // Calculate and save values for positions, bounds, width, height, and side
    app.calculateBounds = function () {
      // Save the existing width and height
      this.previousWidth = this.width
      this.previousHeight = this.height

      // update the width and height to match the window
      this.width = window.innerWidth
      this.height = window.innerHeight

      // Calculate the measurements of player and ball
      this.playerWidth = this.width / 80
      this.playerHeight = this.height / 5
      this.ballSide = this.width / 100

      // calculate the position for center and boundary
      this.centerX = this.width / 2
      this.centerY = this.height / 2
      this.rightBound = this.width - this.playerWidth * 2
      this.leftBound = this.playerWidth
      this.topBound = 0
      this.bottomBound = this.height - this.playerHeight
    }

    // Add the ability to draw text to the canvas
    app.drawText = function (msg, posX, posY, alignment = "center", font = "bold 24px Arial") {
      this.context.font = font
      this.context.textAlign = alignment
      this.context.fillText(msg, posX, posY)
    }

    // Handle the key press event
    function keyDownHandler(e) {
      if (e.keyCode == 38 || e.which == 38) {
        app.playerRight.dy = -5
      }
      if (e.keyCode == 40 || e.which == 40)
        app.playerRight.dy = 5

      if (e.keyCode == 87 || e.which == 87) {
        app.playerLeft.dy = -5
      }
      if (e.keyCode == 83 || e.which == 83) {
        app.playerLeft.dy = 5
      }

      if (e.keyCode == 32 || e.which == 32) {
        app.isStarted = !app.isStarted
      }
    }

    // Handle key release
    function keyUpHandler(e) {
      if (e.keyCode == 38 || e.which == 38 || e.keyCode == 40 || e.which == 40) {
        app.playerRight.dy = 0
      }
      if (e.keyCode == 87 || e.which == 87 || e.keyCode == 83 || e.which == 83) {
        app.playerLeft.dy = 0
      }
    }
    // Listen for keydown events and call the keyDownHandler
    document.addEventListener("keydown", keyDownHandler, false)
    document.addEventListener("keyup", keyUpHandler, false)

  </script>
</body>

</html>